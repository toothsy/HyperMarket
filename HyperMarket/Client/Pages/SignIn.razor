@page "/SignIn"
@inject NavigationManager NavigationManager
@inject IAuthService AuthService
@inject ILocalStorageService LocalStorage
@inject Blazored.SessionStorage.ISessionStorageService sessionStorage
@inject ISnackbar Snackbar

@inject AuthenticationStateProvider AuthStateProvider
<div class="bg">
    <center>
        <EditForm Model="userSignin" OnValidSubmit="HandleGetOTP"  >
            <DataAnnotationsValidator></DataAnnotationsValidator>
            <MudGrid Class="d-flex justify-center align-center">
                <MudItem xs="12" sm="7">
                    <MudCard>
                        <MudCardContent>
                            <h3>Sign In</h3>

                            Please Sign In below or <a href="signup">Sign Up</a> for a new account.

                            <MudTextField Label="Email Id" @bind-Value="userSignin.Email" For="@(()=> userSignin.Email)" InputType="InputType.Email" />
                        </MudCardContent>
                        <MudCardActions>
                            <MudButton ButtonType="ButtonType.Submit" Variant="Variant.Filled" Color="Color.Error" Class="ml-auto">Get OTP</MudButton>
                        </MudCardActions>
                    </MudCard>
                </MudItem>
            </MudGrid>
        </EditForm>

        <EditForm Model="userOTP" OnValidSubmit="HandleSignin" hidden="@(hideForm)">
            <DataAnnotationsValidator></DataAnnotationsValidator>
            <MudGrid Class="d-flex justify-center align-center">
                <MudItem xs="12" sm="7">
                    <MudCard>
                        <MudCardContent>
                            <MudTextField Label="OTP" @bind-Value="userOTP.OTP" For="@(()=> userOTP.OTP)" InputType="InputType.Number" />
                        </MudCardContent>
                        <MudCardActions>
                            <MudButton ButtonType="ButtonType.Submit" Variant="Variant.Filled" Color="Color.Error" Class="ml-auto">Sign In</MudButton>
                        </MudCardActions>
                    </MudCard>
                </MudItem>
            </MudGrid>
        </EditForm>
    </center>
</div>


@code {
    UserSignin userSignin = new UserSignin();
    UserOTP userOTP = new UserOTP();
    private bool hideForm = true;
    private bool disabled = false;

    async void HandleSignin()
    {
        var result = await AuthService.Signin(userSignin, userOTP);
        if (result.Success){
            await LocalStorage.SetItemAsync<string>("authToken", result.Data);
            await AuthStateProvider.GetAuthenticationStateAsync();
            
            AuthenticationState ac = await AuthStateProvider.GetAuthenticationStateAsync();
            int userId = Int32.Parse(ac.User.Claims.First(i => i.Type == System.Security.Claims.ClaimTypes.NameIdentifier).Value);
            await sessionStorage.SetItemAsync("userId", userId );

            if (NavigationManager.Uri.EndsWith("/signin"))
            {
                NavigationManager.NavigateTo("/");
            }
            else
            {
                NavigationManager.NavigateTo(NavigationManager.Uri);
            }
        }
        else{
            StateHasChanged();
            Console.WriteLine(result.Message);
            Snackbar.Add("InValid Information", Severity.Warning);
        }
    }

    async void HandleGetOTP()
    {
        hideForm = !hideForm;
        userSignin.OTPValidate = new OTPValidate() { UserOTP = string.Empty, EncryptedActualOTPTimestamp = string.Empty };
        var result = await AuthService.GetOTP(userSignin);
        if (result.Success)
        {
            Console.WriteLine(result.Message);
            await LocalStorage.SetItemAsync<string>("OTP", result.Data);
            Snackbar.Add("OTP Sent", Severity.Success);
            //disabled = false;
        }
        else
        {
            Console.WriteLine(result.Message);
            Snackbar.Add("InValid Email", Severity.Warning);
        }
    }
}
